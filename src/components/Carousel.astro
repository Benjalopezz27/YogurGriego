---
import fondo from "../assets/fondo.webp";
import fondo2 from "../assets/fondo2.webp";
import fondo3 from "../assets/fondo3.webp";

const slidesProp = Astro.props.slides ?? null;
const id = `hero-${Math.random().toString(36).slice(2, 9)}`;
const defaultSlides = [
  {
    src: fondo.src,
    title: "Yogur Griego",
    subtitle:
      "Hecho en casa, cremoso, natural y alto en proteínas. ¡Probalo hoy por solo $4000!",
    ctaText: "Comprar ahora",
    ctaHref: "#contacto",
  },
  {
    src: fondo2.src,
    title: "Variedades & Sabores",
    subtitle: "¡Probaló con miel, frutas de estación, granola o frutos secos!",
    ctaText: "Ver Recetas",
    ctaHref: "#recetas",
  },
  {
    src: fondo3.src,
    title: "Todos los beneficios",
    subtitle: "Fortalece los huesos. Bajo en calorias y Alto en proteínas.",
    ctaText: "Beneficios",
    ctaHref: "#beneficios",
  },
];
const slides = slidesProp ?? defaultSlides;
---

<div
  id={id}
  data-carousel-id={id}
  class="relative w-full overflow-hidden"
  aria-roledescription="carousel"
>
  <!-- Slides wrapper -->
  <div
    class="flex transition-transform duration-700 ease-in-out"
    data-slides-wrapper
    style={`width: ${slides.length * 100}%; transform: translateX(0%);`}
  >
    {
      slides.map((s: any, i: any) => (
        <div
          class="relative w-full flex-shrink-0"
          style={`width: ${100 / slides.length}%`}
          role="group"
          aria-roledescription="slide"
          aria-label={`Slide ${i + 1} of ${slides.length}`}
          data-slide-index={i}
        >
          <img
            src={s.src}
            alt={s.title}
            class="w-full h-[60vh] md:h-[80vh] object-cover block"
            loading="lazy"
          />

          <div class="absolute inset-0 bg-gradient-to-b from-black/20 via-black/10 to-black/30 pointer-events-none" />

          <div class="absolute inset-0 flex items-center">
            <div class="max-w-2xl px-6 md:px-12 lg:px-16 text-center md:text-left mx-auto md:mx-0">
              <h2 class="text-4xl md:text-6xl lg:text-8xl font-extrabold text-gray-700 drop-shadow-md">
                {s.title}
              </h2>
              <p class="mt-4 text-sm md:text-lg text-gray-700/80 max-w-xl">
                {s.subtitle}
              </p>
              <div class="mt-6">
                <a
                  aria-label={s.ctaText}
                  href={s.ctaHref}
                  class="inline-block bg-red-400 hover:bg-red-500 text-white px-6 py-3 rounded-full font-semibold shadow transition-colors duration-200"
                >
                  {s.ctaText}
                </a>
              </div>
            </div>
          </div>
        </div>
      ))
    }
  </div>

  <!-- Prev/Next buttons -->
  <button
    type="button"
    data-carousel-prev
    class="absolute left-3 top-1/2 -translate-y-1/2 z-30 w-10 h-10 rounded-full bg-white/90 shadow flex items-center justify-center hover:bg-white focus:outline-none"
    aria-label="Anterior slide"
  >
    <!-- left chevron -->
    <svg
      class="w-5 h-5 text-gray-700"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      ><path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M15 18l-6-6 6-6"></path></svg
    >
  </button>

  <button
    type="button"
    data-carousel-next
    class="absolute right-3 top-1/2 -translate-y-1/2 z-30 w-10 h-10 rounded-full bg-white/90 shadow flex items-center justify-center hover:bg-white focus:outline-none"
    aria-label="Siguiente slide"
  >
    <!-- right chevron -->
    <svg
      class="w-5 h-5 text-gray-700"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      ><path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M9 18l6-6-6-6"></path></svg
    >
  </button>

  <!-- Indicators (dots) -->
  <div class="absolute left-0 right-0 bottom-6 flex justify-center gap-2 z-30">
    <div data-carousel-indicators class="flex items-center gap-2"></div>
  </div>
</div>

<script is:inline>
  window.addEventListener("DOMContentLoaded", () => {
    const wrapper = document.querySelector("[data-slides-wrapper]");
    if (!wrapper) return;

    const root = wrapper.closest("[data-carousel-id]") || wrapper.parentElement;
    const total = wrapper.children.length;
    if (!total) return;

    // elements
    const prevBtn = root.querySelector("[data-carousel-prev]");
    const nextBtn = root.querySelector("[data-carousel-next]");
    const indicatorsContainer = root.querySelector(
      "[data-carousel-indicators]"
    );

    let current = 0;

    // prefers-reduced-motion
    const prefersReduced =
      window.matchMedia &&
      window.matchMedia("(prefers-reduced-motion: reduce)").matches;

    // transition
    const durationMs = prefersReduced ? 0 : 700;
    const easing = "cubic-bezier(0.4, 0, 0.2, 1)";
    wrapper.style.transition =
      durationMs > 0 ? `transform ${durationMs}ms ${easing}` : "none";

    // autoplay
    const intervalMs = 3000;
    let timer = null;
    let isPaused = false;

    // create indicators
    const indicators = [];
    for (let i = 0; i < total; i++) {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className =
        "w-2.5 h-2.5 rounded-full bg-white/60 hover:bg-white transition-all duration-150";
      btn.setAttribute("aria-label", `Ir al slide ${i + 1}`);
      btn.dataset.index = String(i);
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        goTo(i);
        restartAutoplay();
      });
      indicatorsContainer.appendChild(btn);
      indicators.push(btn);
    }

    function updateIndicators() {
      indicators.forEach((b, idx) => {
        if (idx === current) {
          b.classList.remove("bg-white/60");
          b.classList.add("bg-white");
        } else {
          b.classList.remove("bg-white");
          b.classList.add("bg-white/60");
        }
      });
    }

    function update() {
      const pct = -(100 / total) * current;
      wrapper.style.transform = `translateX(${pct}%)`;
      updateIndicators();
    }

    function goTo(index) {
      current = ((index % total) + total) % total;
      update();
    }

    function next() {
      goTo(current + 1);
    }
    function prev() {
      goTo(current - 1);
    }

    function start() {
      if (prefersReduced) return;
      stop();
      timer = setInterval(() => {
        if (!isPaused) next();
      }, intervalMs);
    }
    function stop() {
      if (timer) {
        clearInterval(timer);
        timer = null;
      }
    }
    function restartAutoplay() {
      stop();
      start();
    }

    // button listeners
    if (nextBtn) {
      nextBtn.addEventListener("click", (e) => {
        e.preventDefault();
        next();
        restartAutoplay();
      });
    }
    if (prevBtn) {
      prevBtn.addEventListener("click", (e) => {
        e.preventDefault();
        prev();
        restartAutoplay();
      });
    }

    // pause on hover/focus (if not reduced-motion)
    if (!prefersReduced) {
      root.addEventListener("mouseenter", () => {
        isPaused = true;
      });
      root.addEventListener("mouseleave", () => {
        isPaused = false;
      });
      root.addEventListener("focusin", () => {
        isPaused = true;
      });
      root.addEventListener("focusout", () => {
        isPaused = false;
      });
    }

    // keyboard navigation
    root.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft") {
        prev();
        restartAutoplay();
      }
      if (e.key === "ArrowRight") {
        next();
        restartAutoplay();
      }
    });

    // visibility change
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) stop();
      else start();
    });

    // init
    update();
    start();

    // cleanup observer
    const obs = new MutationObserver(() => {
      if (!document.body.contains(wrapper)) {
        stop();
        obs.disconnect();
      }
    });
    obs.observe(document.body, { childList: true, subtree: true });
  });
</script>
